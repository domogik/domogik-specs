

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Purpose &mdash; Domogik specifications 0.1 documentation</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="Domogik specifications 0.1 documentation" href="../../index.html" />
    <link rel="next" title="Minido interface" href="../plugin_minido/plugin_minido.html" />
    <link rel="prev" title="Exemple de fonctionnement du plugin" href="../plugin_knx_exemple/plugin_knx_exemple.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../plugin_minido/plugin_minido.html" title="Minido interface"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../plugin_knx_exemple/plugin_knx_exemple.html" title="Exemple de fonctionnement du plugin"
             accesskey="P">previous</a> |</li>
        <li><a href="../../index.html">Domogik specifications 0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="purpose">
<h1>Purpose<a class="headerlink" href="#purpose" title="Permalink to this headline">¶</a></h1>
<p>A first try to implement the lighting schema in domogik. For now, this plugin is only for plugins developpers.
You must update your plugin to allow scene managment.</p>
</div>
<div class="section" id="installation">
<h1>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h1>
<p>Install the plugin with the package manager in Domogik.
Today, there is no interface for adding scenes, you must create a text file.
Put it into /src/share/domogik/data/lighting/ in develop mode or /var/lib/domogik/domogik_packages/data/lighting in install mode.
The file must have the same name as the scene, followed by the extension &#8221;.scn&#8221;
Here is an example :</p>
<div class="highlight-json"><pre>samtv.scn :

[Scene]
name=samtv
location=Salle à manger
devices=TS24,TS17,TS35,ARRGB1

[TS24]
-1=0,0

[TS17]
-1=20,30

[TS35]
-1=30,30

[ARRGB1]
1=11,0
2=22,0
3=33,0</pre>
</div>
<p>First section [Scene]
Some description about the scene and the important device list.
Under it, you find on sectione per devices, in each one, the configuration of each channel in the device.
By convention, channel -1 is the default channel, 0 represents all the channels and another value a specific channel.
The value of the channel represents the level, followed by the faderate.</p>
<p>After creating the scene file, you can start the plugin.</p>
<p>You can now add a device in domogik, using the Scene devicetype. Use the scene name as address.</p>
</div>
<div class="section" id="update-the-plugin-code">
<h1>Update the plugin code<a class="headerlink" href="#update-the-plugin-code" title="Permalink to this headline">¶</a></h1>
<p>Use the correct lightplugin library :
.. code-block:: json</p>
<blockquote>
<div>from domogik_packages.xpl.lib.lightplugin import LightingExtension</div></blockquote>
<p>Add 3 callbacks fuction to your plugin :
.. code-block:: json</p>
<blockquote>
<div><dl class="docutils">
<dt>def lighting_activate_device(self, device, channel, level, faderate):</dt>
<dd><p class="first">&#8216;&#8217;&#8217;
Activate a device during a scene process.
&#64;param device : address of the device (ie TS14)
&#64;param channel : Not used in this case
&#64;param level : level of light. 0 to say OFF and 100 to say ON
&#64;param faderate : the duration of the scene
&#8216;&#8217;&#8217;
level = int(level)
faderate = int(faderate)
if level == 0 :</p>
<blockquote>
<div>self.send_off(device)</div></blockquote>
<dl class="last docutils">
<dt>elif level == 100 :</dt>
<dd>self.send_on(device)</dd>
<dt>else :</dt>
<dd><dl class="first last docutils">
<dt>if faderate == 0:</dt>
<dd>self.send_dim(device, level)</dd>
<dt>else :</dt>
<dd>self.send_change(device, level, faderate)</dd>
</dl>
</dd>
</dl>
</dd>
<dt>def lighting_deactivate_device(self, device, channel, level, faderate):</dt>
<dd>&#8216;&#8217;&#8217;
Deactivate a device during a scene process.
&#64;param device : address of the device (ie TS14)
&#64;param channel : Not used in this case
&#64;param level : level of light. 0 to say OFF and 100 to say ON
&#64;param faderate : the duration of the scene
&#8216;&#8217;&#8217;
self.send_off(device)</dd>
<dt>def lighting_valid_device(self, device, channel):</dt>
<dd>&#8216;&#8217;&#8217;
Check that device is managed by this plugin. Called when the scene
configuration is loaded.
The first way to do ti is to check the device syntax.
We only accept device like TSX, where X is an integer.
In this case, we do not check that this device exists on telldusd.
The second way to do it, is to try to get configuration from telldusd.
&#64;param deviceid : id of the device (ie 14)
&#64;return : address of the device (ie TS14)
&#8216;&#8217;&#8217;
return self._telldusd.check_device(device)</dd>
</dl>
</div></blockquote>
<p>The 2 first functions are used when a scene is activated or desactivated : they must activate (or deactivate) the (device,channel) passed in parameter. The last one is used to validate that the (device,channel) is managed by this plugin.</p>
<p>Finally, add the following lines to your plugin initialisation :
.. code-block:: json</p>
<blockquote>
<div><p>self._lighting = LightingExtension(self)
self._lighting.enable_lighting(self._mytelldus.lighting_activate_device,</p>
<blockquote>
<div>self._mytelldus.lighting_deactivate_device, self._mytelldus.lighting_valid_device)</div></blockquote>
</div></blockquote>
</div>
<div class="section" id="how-it-works">
<h1>How it works<a class="headerlink" href="#how-it-works" title="Permalink to this headline">¶</a></h1>
<p>The lightplugin library asks informations to the lighting server. This one send a list of all the scenes it managed.
Then the lighting extension ask for configuration of every scenes. The server sends each scene, with the device configuration. Using this information, the plugin build a list of devices to activated for every scene.
Now, the plugin will manage scene activation (and deactivation) directly.</p>
<blockquote>
<div>Xpl schema</div></blockquote>
<hr class="docutils" />
<p>You can also use xpl to manage scene/device under the lighting device :
Getting the scene list
<strong>*******************</strong></p>
<div class="highlight-json"><pre>xpl-cmnd
lighting.config
{
command=scnlist
[client=fooplugin]
}</pre>
</div>
<p>The server will respond :
.. code-block:: json</p>
<blockquote>
<div><blockquote>
<div>xpl-stat
lighting.config
{
command=scnlist
status=ok
scene-count=2
scenes=foo,samtv
}</div></blockquote>
<p>Get informations about a scene</p>
</div></blockquote>
<hr class="docutils" />
<div class="highlight-json"><pre>xpl-cmnd
lighting.config
{
command=scninfo
scene=foo
[client=fooplugin]
}</pre>
</div>
<p>The server will respond :
.. code-block:: json</p>
<blockquote>
<div>xpl-stat
lighting.config
{
command=scninfo
[client=fooplugin]
status=ok
scene=foo
name=foo
room=None
floor=None
comment=None
device-count=5
device=TS34,-1,0,0
device=ARGD,1,1,1
device=ARGD,2,2,2
device=ARGD,3,3,3
device=TS17,-1,50,30
}</div></blockquote>
<div class="section" id="adding-a-scene">
<h2>Adding a scene<a class="headerlink" href="#adding-a-scene" title="Permalink to this headline">¶</a></h2>
<div class="highlight-json"><pre>xpl-cmnd
lighting.config
{
command=scnadd
scene=foo
name=test scene
}</pre>
</div>
</div>
<div class="section" id="deleting-a-scene">
<h2>Deleting a scene<a class="headerlink" href="#deleting-a-scene" title="Permalink to this headline">¶</a></h2>
<div class="highlight-json"><pre>xpl-cmnd
lighting.config
{
command=scndel
scene=foo
}</pre>
</div>
</div>
<div class="section" id="adding-a-device-to-a-scene">
<h2>Adding a device to a scene<a class="headerlink" href="#adding-a-device-to-a-scene" title="Permalink to this headline">¶</a></h2>
<div class="highlight-json"><pre>xpl-cmnd
lighting.config
{
command=scnadddev
scene=foo
device=TS17
channel=-1,50,30
}</pre>
</div>
<p>or adding a multichannel device to a scene
.. code-block:: json</p>
<blockquote>
<div>xpl-cmnd
lighting.config
{
command=scnadddev
scene=foo
device=ARGD
channel=1,1,1
channel=2,2,2
channel=3,3,3
}</div></blockquote>
</div>
<div class="section" id="deleting-a-device-from-a-scene">
<h2>Deleting a device from a scene<a class="headerlink" href="#deleting-a-device-from-a-scene" title="Permalink to this headline">¶</a></h2>
<p>Deleting specifics channels :
.. code-block:: json</p>
<blockquote>
<div>xpl-cmnd
lighting.config
{
command=scndeldev
scene=foo
device=ARG2
channel=2
}</div></blockquote>
<p>or deleting of all channels
.. code-block:: json</p>
<blockquote>
<div>xpl-cmnd
lighting.config
{
command=scndeldev
scene=foo
device=TS17
channel=0
}</div></blockquote>
</div>
<div class="section" id="trigs-updates">
<h2>Trigs updates<a class="headerlink" href="#trigs-updates" title="Permalink to this headline">¶</a></h2>
<p>Whe a scene is modified on the server, it will send a message
.. code-block:: json</p>
<blockquote>
<div>xpl-trig
lighting.config
{
command=scninfo
status=ok
scene=foo
name=foo
room=None
floor=None
comment=None
device-count=5
device=TS34,-1,0,0
device=ARGD,1,1,1
device=ARGD,2,2,2
device=ARGD,3,3,3
device=TS17,-1,50,30
}</div></blockquote>
<p>If the scene is deleted, the device list will be empty.</p>
</div>
</div>
<div class="section" id="using-it-with-an-arduino">
<h1>Using it with an arduino<a class="headerlink" href="#using-it-with-an-arduino" title="Permalink to this headline">¶</a></h1>
<p>The next step is to build an arduino library.</p>
</div>
<div class="section" id="old-documentation">
<h1>Old documentation<a class="headerlink" href="#old-documentation" title="Permalink to this headline">¶</a></h1>
<p>Implementation of the LIGHTING schema in Domogik.
This plugin is in early stage, so it is not publish into the sources. Actually, configuration is store directly in code, so it should be a bad idea to share it.
For now, this page is only a memento.
The full schema is available <a href="#id1"><span class="problematic" id="id2">`here &lt;http://xplproject.org.uk/wiki/index.php?title=Schema\_-\_LIGHTING&gt;`_</span></a>
If you want to participate, please do it.</p>
<div class="section" id="developpers-notes">
<h2>Developpers notes<a class="headerlink" href="#developpers-notes" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="notes-about-the-lighting-schema-notion">
<h2>Notes about the lighting schema notion :<a class="headerlink" href="#notes-about-the-lighting-schema-notion" title="Permalink to this headline">¶</a></h2>
<p><a href="#id3"><span class="problematic" id="id4">`Gateway &lt;http://xplproject.org.uk/wiki/index.php?title=Schema\_-\_LIGHTING#xPL\_gateway&gt;`_</span></a> : implemented
<a href="#id5"><span class="problematic" id="id6">`Networks &lt;http://xplproject.org.uk/wiki/index.php?title=Schema\_-\_LIGHTING#Network&gt;`_</span></a> : not implemented. Nobody use it for now, so we always work in the preferred network.  We silently ignore this option as mention in documentation.
<a href="#id7"><span class="problematic" id="id8">`Devices &lt;http://xplproject.org.uk/wiki/index.php?title=Schema\_-\_LIGHTING#Device&gt;`_</span></a> : implemented.
<a href="#id9"><span class="problematic" id="id10">`Channels &lt;http://xplproject.org.uk/wiki/index.php?title=Schema\_-\_LIGHTING#Channels&gt;`_</span></a> : implementation in progress. For now, one channel by device is developed but multichannels devices will be soon.
<a href="#id11"><span class="problematic" id="id12">`Faderate &lt;http://xplproject.org.uk/wiki/index.php?title=Schema\_-\_LIGHTING#Fade\_Rate&gt;`_</span></a> : not implemented. Don&#8217;t know if it will be. Options are present in messages but silently ignored.
<a href="#id13"><span class="problematic" id="id14">`Scenes &lt;http://xplproject.org.uk/wiki/index.php?title=Schema\_-\_LIGHTING#Scene&gt;`_</span></a> : Implemented.
Activating and deactivating scenes is implemented. Goto not (dont need it)</p>
<p>!!!! Problems
When activating a scene, I send a message to every device using the xpl network. It tooks approximatively 1 second to activate a device. In a scene with 10 devices, it take more than 10 seconds to activate it.
Need to fid a workaround to this.</p>
</div>
<div class="section" id="externals">
<h2>Externals<a class="headerlink" href="#externals" title="Permalink to this headline">¶</a></h2>
<p>One interesting thing in implementing this schema is that it can manage external stuff (like arduinos).</p>
<p>!!!! First case of use : ARLIGHT
ARLIGHT is an evolution of ar_rgb.</p>
<p>!!!!! Device&#8217;s names
I need to add a move detector, a sound ans a vibration sensor to it.
My house need to know if I am here, so I need many move detectors. Arduino is a good place to add one :)
So the arduino will create 2 or more devices
how should we name them ?</p>
<blockquote>
<div>: one for the rgb in the lighting schema and another using the sensor basic.</div></blockquote>
<p>Configuration of the movement detector is trvial, so we don&#8217;t care about it for now. We only study the case of the RGB</p>
<p>What can domogik do ?
!!!!! Configuration
For now, all the configuration (ip,source,device name, ...) is store in the code.
If we want to update them, we need to create a small web server on the arduino, use the serial console, or we can try to use them in domogik :</p>
<p>When the arduino starts, it asks informations about its RGB device, including all parameters it wants.
Ligthing catch the message. If a configuration is available, it send it to the arduino. If none, it creates the required fileds in lightings devices. User update the configuration and save it.
The arduino will loop until it can get a configuration.
When it get one, it starts (entering in a &#8220;normal&#8221; loop)</p>
<div class="highlight-json"><pre>xpl-cmnd
{
hop=1
source=domogik-send.satellitep100
target=*
}
lighting.request
{
request=devconf
device=ARRGB1
}</pre>
</div>
<div class="highlight-json"><pre>xpl-stat
{
hop=1
source=domogik-lighting.satellitep100
target=*
}
lighting.devconf
{
status=ok
device=ARRGB1
name=Ar_Light RGB
report-on-manual=false
room=Salle à manger
scene-count=9
scene=samtv,1,11,0
scene=samtv,2,22,0
scene=samtv,3,33,0
scene=samamb,1,AA,0
scene=samamb,2,BB,0
scene=samamb,3,CC,0
scene=samall,1,DD,0
scene=samall,2,EE,0
scene=samall,3,FF,0
}</pre>
</div>
<p>This process is based on the device name. We will use the serial to initialize it. We can also use the DHCP hostname. I will try it later as the EthernetUdp and DHCP/DNS is broken in Arduino 1.0.</p>
<p>Now we must tell the LIGHTING that ARLIGHT can respond to scene messages (and the device one too(maybe a bad idea)).
2 ways to do this :
ARLIGHT say to LIGHTING the messages it can manage or LIGHTING ask ARLIGHT before sending message.
I prefer the first one.
When ARLIGHT starts, it register its channels and actions (on,off, dim, activate and deactivate) in LIGHTING.
If configuration has been updated, it reload it ?
For now, we don&#8217;t implement this. But we should remenber it.</p>
<p>!!!!! Actions
A device can know the scenes in which it is an actor. So maybe it can catch directly scene message, not the devices ones.
My arduino is a AtMega 2560. It has 8KB of SRAM and 4KB of eeprom.
We will use the eeprom to store configuration of the device : name,heartbeat,room,floor or scenes.
What do we need :
* functions to read and write the differents parameters.
* functions to find and append scenes
* fucntions to format and check the pseudo file on eeprom
EEPROM has a limited number of writes (from thousand to thousand of thousand). Don&#8217;t known what about the arduino one. And you ?</p>
<p>Scene/Device message.
We want that ARLIGHT manage directly scene messages : so when lighting receive a message, it doesn&#8217;t send to the ARLIGHT.</p>
<p>!!!!! RGB/Channels.
Actually the plugin send the color using the standard RGB format.
<a href="#id15"><span class="problematic" id="id16">`Channels in lighting &lt;http://xplproject.org.uk/wiki/index.php?title=Schema\_-\_LIGHTING#Channels&gt;`_</span></a> are used to manage differents lights on the same device.
We will use the level parameter to store the R ( or G or B ) composante of the color.
Channels :
1 : R
2 : G
3 : B
0 : All channels</p>
<p>In ligthing, we could use the channels to send the color.
We must include all the 3 channels in one XPL message. Otherwise, it can take up to 3 seconds to switch to the new color.</p>
<div class="highlight-json"><pre>{
hop=1
source=domogik-lighting.satellitep100
target=*
}
lighting.devinfo
{
status=not-found
device=ARRGB1
name=Ar_Light RGB
report-on-manual=false
room=Salle à manger
channel-count=3
primary-channel=1
channel=1,true,FF,0
channel=2,true,FF,0
channel=3,true,FF,0
scene-count=0
}</pre>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Purpose</a></li>
<li><a class="reference internal" href="#installation">Installation</a></li>
<li><a class="reference internal" href="#update-the-plugin-code">Update the plugin code</a></li>
<li><a class="reference internal" href="#how-it-works">How it works</a><ul>
<li><a class="reference internal" href="#adding-a-scene">Adding a scene</a></li>
<li><a class="reference internal" href="#deleting-a-scene">Deleting a scene</a></li>
<li><a class="reference internal" href="#adding-a-device-to-a-scene">Adding a device to a scene</a></li>
<li><a class="reference internal" href="#deleting-a-device-from-a-scene">Deleting a device from a scene</a></li>
<li><a class="reference internal" href="#trigs-updates">Trigs updates</a></li>
</ul>
</li>
<li><a class="reference internal" href="#using-it-with-an-arduino">Using it with an arduino</a></li>
<li><a class="reference internal" href="#old-documentation">Old documentation</a><ul>
<li><a class="reference internal" href="#developpers-notes">Developpers notes</a></li>
<li><a class="reference internal" href="#notes-about-the-lighting-schema-notion">Notes about the lighting schema notion :</a></li>
<li><a class="reference internal" href="#externals">Externals</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="../plugin_knx_exemple/plugin_knx_exemple.html"
                        title="previous chapter">Exemple de fonctionnement du plugin</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../plugin_minido/plugin_minido.html"
                        title="next chapter">Minido interface</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../_sources/pages/plugin_lighting/plugin_lighting.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../plugin_minido/plugin_minido.html" title="Minido interface"
             >next</a> |</li>
        <li class="right" >
          <a href="../plugin_knx_exemple/plugin_knx_exemple.html" title="Exemple de fonctionnement du plugin"
             >previous</a> |</li>
        <li><a href="../../index.html">Domogik specifications 0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Domogik team.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>